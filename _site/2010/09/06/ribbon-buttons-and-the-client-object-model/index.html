
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Ribbon buttons and the Client Object Model</title>
    
    <meta name="author" content="Peter Gerritsen">

    <!-- Enable responsive viewport -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <!-- Le styles -->
    <link href="/assets/themes/twitter/bootstrap/css/bootstrap.2.2.2.min.css" rel="stylesheet">
    <link href="/assets/themes/twitter/css/style.css?body=1" rel="stylesheet" type="text/css" media="all">

    <!-- Le fav and touch icons -->
  <!-- Update these with your own images
    <link rel="shortcut icon" href="images/favicon.ico">
    <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
  -->

    <!-- atom & rss feed -->
    <link href="/atom.xml" type="application/atom+xml" rel="alternate" title="Sitewide ATOM Feed">
    <link href="/rss.xml" type="application/rss+xml" rel="alternate" title="Sitewide RSS Feed">

  </head>

  <body>
    <div class="navbar">
      <div class="navbar-inner">
        <div class="container-narrow">
          <a class="brand" href="/">Peter Gerritsen’s blog</a>
          <ul class="nav">
            
            
            


  
    
      
      	
      	<li><a href="/archive.html">Archive</a></li>
      	
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/categories.html">Categories</a></li>
      	
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/pages.html">Pages</a></li>
      	
      
    
  
    
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/tags.html">Tags</a></li>
      	
      
    
  



          </ul>
        </div>
      </div>
    </div>

    <div class="container-narrow">

      <div class="content">
        
<div class="page-header">
  <h1>Ribbon buttons and the Client Object Model </h1>
</div>

<div class="row-fluid post-full">
  <div class="span12">
    <div class="date">
      <span>06 September 2010</span>
    </div>
    <div class="content">
      <p>One of the standard Ribbon buttons in SharePoint 2010 allows you to mail a link to a document. Unfortunately the dev team at Microsoft didn’t update the functionality of this button to use one of the enhanced UI features: multiple selection. When you select 2 or more items, the button is automatically disabled.</p>

<p>To bypass this inconvenience, we decided to implement our own version of the button to replace the standard button. Replacing a button is actually quite easy with the UI extensibility options in SP2010.</p>

<p>First of, I started with an empty SharePoint project in Visual Studio 2010. I chose to create a sandboxed solution. Because we need to deploy and inject a JavaScript file on every page, I decided to go for the solution Jan Tielens introduced in his blog post ‘<a href='http://weblogs.asp.net/jan/archive/2010/09/02/deploying-and-using-jquery-with-a-sharepoint-2010-sandboxed-solution.aspx'>Deploying and using jQuery with a SharePoint 2010 Sandboxed Solution</a>’.</p>

<p>First of I added an empty element item to the project called Buttons. In this element I included the XML to hide the existing button and inject my own button:</p>

<p><code>xml
&lt;CustomAction
Id=&quot;TTSendLinksEmailRemoveRibbonButton&quot;
Location=&quot;CommandUI.Ribbon&quot;&gt;
&lt;CommandUIExtension&gt;
&lt;CommandUIDefinitions&gt;
&lt;CommandUIDefinition
Location=&quot;Ribbon.Documents.Share.EmailItemLink&quot; /&gt;
&lt;/CommandUIDefinitions&gt;
&lt;/CommandUIExtension&gt;
&lt;/CustomAction&gt;
&lt;CustomAction
Id=&quot;TTSendLinksEmailButton&quot;
Location=&quot;CommandUI.Ribbon&quot;
Sequence=&quot;15&quot;
Title=&quot;E-mail a link&quot;&gt;
&lt;CommandUIExtension&gt;
&lt;CommandUIDefinitions&gt;
&lt;CommandUIDefinition Location=&quot;Ribbon.Documents.Share.Controls._children&quot;&gt;
&lt;Button
Id=&quot;Ribbon.Documents.Share.TTSendLinksEmailButton&quot;
Alt=&quot;$Resources:core,cui_ButEmailLink;&quot;
LabelText=&quot;$Resources:core,cui_ButEmailLink;&quot;
ToolTipTitle=&quot;$Resources:core,cui_ButEmailLink;&quot;
ToolTipDescription=&quot;$Resources:core,cui_STT_ButEmailLinkDocument;&quot;
Sequence=&quot;15&quot;
Command=&quot;TT_SendLinksEmail_Button&quot;
Image16by16=&quot;/_layouts/$Resources:core,Language;/images/formatmap16x16.png&quot;
Image16by16Top=&quot;-16&quot;
Image16by16Left=&quot;-88&quot;
Image32by32=&quot;/_layouts/$Resources:core,Language;/images/formatmap32x32.png&quot;
Image32by32Top=&quot;-128&quot;
Image32by32Left=&quot;-448&quot;
TemplateAlias=&quot;o1&quot; /&gt;
&lt;/CommandUIDefinition&gt;
&lt;/CommandUIDefinitions&gt;
&lt;CommandUIHandlers&gt;
&lt;CommandUIHandler
Command=&quot;TT_SendLinksEmail_Button&quot;
CommandAction=&quot;javascript:function sendLinksMail() {
TamTam_SP2010_SendLinksMail_SendLinksMail();
}
sendLinksMail();&quot;
EnabledScript=&quot;javascript:function oneOrMoreEnable() {
var items = SP.ListOperation.Selection.getSelectedItems();
var ci = CountDictionary(items);
return (ci &gt; 0);
}
oneOrMoreEnable();&quot; /&gt;
&lt;/CommandUIHandlers&gt;
&lt;/CommandUIExtension&gt;
&lt;/CustomAction&gt;
</code></p>

<p>For my own button, I copied the resourcestrings from the original XML that is in CMDUI.xml (14\TEMPLATE\GLOBAL\XML). This way the button gets the same look and feel and localized labels as the original button. When pressing the button the JavaScript function TamTam_SP2010_SendLinksMail_SendLinksMail is called. The EnabledScript enables the button when 1 or more items are selected.</p>

<p>To make sure the JavaScript is included, we’ll use a CustomAction element with ScriptLink as location (for more information see the previously mentioned blogpost by Jan Tielens):</p>

<p><code>xml
&lt;CustomAction
ScriptSrc=&quot;~SiteCollection/SiteAssets/TamTam.SP2010.EmailALinkMultiple.js&quot;
Location=&quot;ScriptLink&quot;
Sequence=&quot;10&quot;&gt;
&lt;/CustomAction&gt;
</code></p>

<p>Now all we have to do is create the necessary JavaScript. The out-of-the-box functionality opens the users email client with the link to the selected document in the body of the message.</p>

<p>To create the body of the message we’ll need to retrieve the link for every selected item by use of the Client Object Model. First we’ll get the ClientContext, the SPSite, the list were in and the id’s of the selected items:</p>

<p><code>javascript
TamTam_SP2010_SendLinksMail_SendLinksMail = function () {
this.selectedItems = SP.ListOperation.Selection.getSelectedItems();
this.selectedListGuid = SP.ListOperation.Selection.getSelectedList();
this.context = SP.ClientContext.get_current();
this.site = this.context.get_site();
this.context.load(this.site);
this.web = this.context.get_web()
this.selectedList = this.web.get_lists().getById(this.selectedListGuid);
}
</code></p>

<p>We then need to get the listitem object for every selected item. Because this is an asynchronous operation we’ll create an array, include every selected listitem in there and tell the context to load each item before calling executeQueryAsync:</p>

<p><code>javascript
this.selectedFiles = new Array();
var k;
for (k in this.selectedItems) {
this.selectedFiles.push(this.selectedList.getItemById(this.selectedItems[k].id).get_file());
this.context.load(this.selectedFiles[k]);
}
this.context.executeQueryAsync(Function.createDelegate(this, TamTam_SP2010_SendLinksMail_onQuerySucceeded), Function.createDelegate(this, TamTam_SP2010_SendLinksMail_onQueryFailed));
</code></p>

<p>Then in the onQuerySucceeded callback function we can get the url’s for the items and construct the email:</p>

<p><code>javascript
TamTam_SP2010_SendLinksMail_onQuerySucceeded = function () {
var siteUrl = this.site.get_url();
var k;
var bodystring = &quot;&quot;;
for (k in this.selectedFiles) {
var fileUrl = this.selectedFiles[k].get_serverRelativeUrl();
bodystring += siteUrl + fileUrl + &quot;%0d%0a%0d%0a&quot;;
}
window.open(&#39;mailto:?body=&#39; + bodystring);
}
</code></p>
    </div>

    

  
    <ul class="tag_box inline">
      <li><i class="icon-tags"></i></li>
      
      


  
     
    	<li><a href="/tags.html#Ribbon buttons-ref">Ribbon buttons <span>1</span></a></li>
     
    	<li><a href="/tags.html#Sandboxed-ref">Sandboxed <span>1</span></a></li>
     
    	<li><a href="/tags.html#SP2010-ref">SP2010 <span>20</span></a></li>
    
  



    </ul>
    

    <hr>
    <div class="pagination">
      <ul>
      
        <li class="prev"><a href="/2010/07/12/css-contents-showing-in-settings-page-for-site-based-on-custom-template" title="CSS contents showing in settings page for site based on custom template">&larr; Previous</a></li>
      
        <li><a href="/archive.html">Archive</a></li>
      
        <li class="next"><a href="/2010/09/20/strange-fulltextsqlquery-query-behaviour-system-servicemodel-faultexception" title="Strange FullTextSqlQuery query behaviour (System.ServiceModel.FaultException)">Next &rarr;</a></li>
      
      </ul>
    </div>
    <hr>
    


  <div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_developer = 1;
    var disqus_shortname = 'jekyllbootstrap'; // required: replace example with your forum shortname
    var disqus_identifier = '832 http://username.github.io/?p=832';
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>




  </div>
</div>


      </div>
      <hr>
      <footer>
        <p>&copy; 2013 Peter Gerritsen
          with help from <a href="http://jekyllbootstrap.com" target="_blank" title="The Definitive Jekyll Blogging Framework">Jekyll Bootstrap</a>
          and <a href="http://twitter.github.com/bootstrap/" target="_blank">Twitter Bootstrap</a>
        </p>
      </footer>

    </div>

    
  </body>
</html>

