
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Building an AJAX web part with jQuery (Part 1)</title>
    
    <meta name="author" content="Peter Gerritsen">

    <!-- Enable responsive viewport -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <!-- Le styles -->
    <link href="/assets/themes/twitter/bootstrap/css/bootstrap.2.2.2.min.css" rel="stylesheet">
    <link href="/assets/themes/twitter/css/style.css?body=1" rel="stylesheet" type="text/css" media="all">

    <!-- Le fav and touch icons -->
  <!-- Update these with your own images
    <link rel="shortcut icon" href="images/favicon.ico">
    <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
  -->

    <!-- atom & rss feed -->
    <link href="/atom.xml" type="application/atom+xml" rel="alternate" title="Sitewide ATOM Feed">
    <link href="/rss.xml" type="application/rss+xml" rel="alternate" title="Sitewide RSS Feed">

  </head>

  <body>
    <div class="navbar">
      <div class="navbar-inner">
        <div class="container-narrow">
          <a class="brand" href="/">Peter Gerritsen’s blog</a>
          <ul class="nav">
            
            
            


  
    
      
      	
      	<li><a href="/archive.html">Archive</a></li>
      	
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/categories.html">Categories</a></li>
      	
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/pages.html">Pages</a></li>
      	
      
    
  
    
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/tags.html">Tags</a></li>
      	
      
    
  



          </ul>
        </div>
      </div>
    </div>

    <div class="container-narrow">

      <div class="content">
        
<div class="page-header">
  <h1>Building an AJAX web part with jQuery (Part 1) </h1>
</div>

<div class="row-fluid post-full">
  <div class="span12">
    <div class="date">
      <span>30 March 2009</span>
    </div>
    <div class="content">
      <p>In this series of posts I will describe how I build a web part full of AJAX functionality using jQuery and some plugins for jQuery.</p>

<h4 id='why'>Why?</h4>

<p>ASP.Net AJAX is quite hard to implement using only code. Besides that, having multiple updatepanels and multiple triggers outside of these updatepanels, can complicate stuff very quickly. So I decided to see how much time I would need to build the required functionality using JavaScript with jQuery.</p>

<p><strong>What?</strong></p>

<p>The web part of choice was one that would allow visitors of the portal to order a bunch of products from different categories. Products are stored in a list and have a choice sitecolumn to specify the category of the item. Products can be selected and added to a shopping cart. After the wanted items are added to the shopping cart, the user can specify some comments, a handling method (Pick-up or deliver) and a delivery-/pickup date and send in the order. The order information is saved in a list, the user gets a confirmation email and the shopping cart is cleared. The resulting web part look like this (sorry for the dutch interface):</p>

<p><a href='http://blog.petergerritsen.nl/wp-content/uploads/snipping24.png'><img alt='image' src='http://blog.petergerritsen.nl/wp-content/uploads/snipping25.png' /></a></p>

<p><strong>How?</strong></p>

<p>For getting the categories and products we’ll use a generic handler. This offers the possibility of caching and is perfectly suitable for read-only data access. The shopping cart and order functionality will be provided through a ASP.Net Webservice. Both the handler and web service will return JSON data. We’ll need ASP.Net 3.5 for this.</p>

<p>The web part will only override the render method and write out the needed HTML. So no control instantiation, event handling or other code.</p>

<p><strong>Useful links</strong></p>

<p>Dave Ward’s weblog on <a href='http://encosia.com/'>encosia.com</a> provides a vital source for information on combining jQuery and ASP.Net. Also <a href='http://www.west-wind.com/Weblog/'>Rick Strahl</a> has some useful posts on this subject.</p>

<p><strong>Building the products handler</strong></p>

<p>We’ll start by building the Generic Handler that returns JSON data for categories and products. We’ll differentiate between the two by passing in the type with the query string. I’ve created two classes for data retrieval from the list in SharePoint, one that returns the choices of the categories and one that returns the products based on the category. We’ll then use the DataContractJsonSerializer to generate and return the JSON for this data:</p>

<p><code>csharp
public void ProcessRequest(HttpContext context)
{
try
{
if (string.IsNullOrEmpty(context.Request[&quot;type&quot;]))
throw new ArgumentException(&quot;type not specified or null&quot;);
string type = context.Request[&quot;type&quot;];
context.Response.Cache.SetExpires(DateTime.Now.AddSeconds(300));
context.Response.Cache.SetCacheability(HttpCacheability.Public);
if (type.Equals(&quot;categories&quot;, StringComparison.InvariantCultureIgnoreCase))
{
StringCollection categories = BPVProductCategory.GetProductCategories();
DataContractJsonSerializer ser = new DataContractJsonSerializer(typeof(StringCollection));
ser.WriteObject(context.Response.OutputStream, categories);
}
    if (type.Equals(&quot;products&quot;, StringComparison.InvariantCultureIgnoreCase))
    {
        if (string.IsNullOrEmpty(context.Request[&quot;category&quot;]))
        throw new ArgumentException(&quot;category not specified or null&quot;);
        string category = HttpUtility.UrlDecode(context.Request[&quot;category&quot;]);
        Ecabo.Intranet2009.SharePoint.Diagnostics.Logging.LogMessageFormat(&quot;Category: {0}&quot;, category);
        List products = BPVProduct.GetAvailableProducts(category);
        DataContractJsonSerializer ser = new DataContractJsonSerializer(typeof(List));
        ser.WriteObject(context.Response.OutputStream, products);
    }
}
catch (Exception ex)
{
    context.Response.Write(string.Format(&quot;ERROR: {0}&quot;, ex.Message));
}
}
</code></p>

<h4 id='building_the_shopping_cart_web_service'>Building the shopping cart web service</h4>

<p>Next, we need to create a web service that will allows us to modify the shopping cart with add, remove, change and clear methods. This web service will also contain a method to place the order. To make sure this web service will return JSON when requested, we’ll decorate the class with the ScriptService attribute (normally you just have to comment out the automatically included line in the class definition) and we decorate the methods with the ScriptMethod attribute in which we specify the ResponseFormat to be JSON. To store the shoppingcart between requests to the service we’ll use the Session. In order for that to work we add the EnableSession=true parameter to the WebMethod attribute of each method. The resulting code looks like this:</p>

<p><code>csharp
[WebService(Namespace = &quot;http://sharepoint.ecabo.nl/200903/&quot;)]
[WebServiceBinding(ConformsTo = WsiProfiles.BasicProfile1_1)]
[System.ComponentModel.ToolboxItem(false)]
// To allow this Web Service to be called from script, using ASP.NET AJAX, uncomment the following line.
[System.Web.Script.Services.ScriptService]
public class BPVShoppingCart : System.Web.Services.WebService
{
private List ShoppingCart
{
get
{
if (HttpContext.Current.Session[&quot;BPVShoppingCart&quot;] != null)
{
return (List)HttpContext.Current.Session[&quot;BPVShoppingCart&quot;];
}
else
{
List shoppingCart = new List();
HttpContext.Current.Session.Add(&quot;BPVShoppingCart&quot;, shoppingCart);
return shoppingCart;
}
}
set
{
HttpContext.Current.Session[&quot;BPVShoppingCart&quot;] = value;
}
}
[WebMethod(EnableSession = true)]
[ScriptMethod(ResponseFormat = ResponseFormat.Json)]
public List GetItems()
{
try
{
return ShoppingCart;
}
catch (Exception ex)
{
Ecabo.Intranet2009.SharePoint.Diagnostics.Logging.LogException(ex);
return null;
}
}
[WebMethod(EnableSession = true)]
[ScriptMethod(ResponseFormat = ResponseFormat.Json)]
public List AddItem(string productName, int productId, string productCode, int amount)
{
try
{
ShoppingCartItem item = ShoppingCart.Find(p =&gt; p.ProductID == productId);
if (item == null)
{
item = new ShoppingCartItem();
item.Amount = amount;
item.ProductCode = productCode;
item.ProductID = productId;
item.ProductName = productName;
ShoppingCart.Add(item);
}
else
{
item.Amount += amount;
}
return ShoppingCart;
}
catch (Exception ex)
{
Ecabo.Intranet2009.SharePoint.Diagnostics.Logging.LogException(ex);
return null;
}
}
[WebMethod(EnableSession = true)]
[ScriptMethod(ResponseFormat = ResponseFormat.Json)]
public List DeleteItem(int productId)
{
try
{
ShoppingCartItem item = ShoppingCart.Find(p =&gt; p.ProductID == productId);
if (item != null)
{
ShoppingCart.Remove(item);
}
return ShoppingCart;
}
catch (Exception ex)
{
Ecabo.Intranet2009.SharePoint.Diagnostics.Logging.LogException(ex);
return null;
}
}
[WebMethod(EnableSession = true)]
[ScriptMethod(ResponseFormat = ResponseFormat.Json)]
public List ChangeAmount(int productId, int amount)
{
try
{
if (amount == 0)
return DeleteItem(productId);
ShoppingCartItem item = ShoppingCart.Find(p =&gt; p.ProductID == productId);
if (item != null)
{
item.Amount = amount;
}
return ShoppingCart;
}
catch (Exception ex)
{
Ecabo.Intranet2009.SharePoint.Diagnostics.Logging.LogException(ex);
return null;
}
}
[WebMethod(EnableSession = true)]
[ScriptMethod(ResponseFormat = ResponseFormat.Json)]
public List ClearCart()
{
try
{
ShoppingCart.Clear();
return ShoppingCart;
}
catch (Exception ex)
{
Ecabo.Intranet2009.SharePoint.Diagnostics.Logging.LogException(ex);
return null;
}
}
[WebMethod(EnableSession = true)]
[ScriptMethod(ResponseFormat = ResponseFormat.Json)]
public List PlaceOrder(string comments, string deliveryType, string deliveryDate)
{
try
{
string products = &quot;&quot;;
foreach (ShoppingCartItem item in ShoppingCart)
{
products += string.Format(&quot;{0} - {1} - {2}\r\n&quot;, item.ProductCode, item.Amount, item.ProductName);
}
BPVBestelling bestelling = new BPVBestelling();
bestelling.Comments = comments;
bestelling.Handling = deliveryType;
bestelling.HandlingDate = Convert.ToDateTime(deliveryDate, new CultureInfo(&quot;nl-NL&quot;));
bestelling.Title = DateTime.Now.ToString(&quot;yyyyMMdd_HHmm&quot;) + &quot;_&quot; + SPContext.Current.Web.CurrentUser.Email;
bestelling.Products = products;
bestelling.PlacedBy = SPContext.Current.Web.CurrentUser;
if (BPVBestelling.AddBestelling(bestelling))
{
BPVBestelling.SendConfirmationEmail(bestelling, ShoppingCart);
ShoppingCart.Clear();
return ShoppingCart;
}
else
throw new Exception(&quot;Het is niet mogelijk om uw bestelling te verwerken&quot;);
}
catch (Exception ex)
{
Ecabo.Intranet2009.SharePoint.Diagnostics.Logging.LogException(ex);
throw new Exception(&quot;Het is niet mogelijk om uw bestelling te verwerken&quot;, ex);
}
}
}
</code></p>

<p>There’s one more thing needed for letting the web service return the data in JSON format. We need to include a httpHandler in the web.config for the asmx extension that routes the request to the ScriptHandlerFactory. An easy way to do this is for your SharePoint webapp by creating a blank web.config and placing it in a subfolder of the layouts directory where you also place the asmx file. The following is all you need in that web.config file:</p>

<p><code>xml
&lt;?xml version=&quot;1.0&quot; standalone=&quot;yes&quot;?&gt;
&lt;configuration&gt;
&lt;system.web&gt;
&lt;httpHandlers&gt;
&lt;add verb=&quot;*&quot; path=&quot;*.asmx&quot; validate=&quot;false&quot; type=&quot;System.Web.Script.Services.ScriptHandlerFactory, System.Web.Extensions, Version=3.5.0.0, Culture=neutral, PublicKeyToken=31BF3856AD364E35&quot;/&gt;
&lt;/httpHandlers&gt;
&lt;compilation debug=&quot;true&quot;/&gt;&lt;/system.web&gt;
&lt;/configuration&gt;
</code></p>

<p><strong>Next parts</strong></p>

<p>That wraps it up for this first post in the series. In <a href='http://blog.petergerritsen.nl/2009/03/31/building-an-ajax-web-part-with-jquery-part-2/'>part 2</a> I’ll show you how to call these services from jQuery and insert the data in the HTML of the webpart. In <a href='http://blog.petergerritsen.nl/2009/05/16/what-asp-net-developers-should-know-about-jquery/'>part 3</a> we’ll enhance the experience by including dialogs and validation in the solution.</p>
    </div>

    

  
    <ul class="tag_box inline">
      <li><i class="icon-tags"></i></li>
      
      


  
     
    	<li><a href="/tags.html#AJAX-ref">AJAX <span>5</span></a></li>
     
    	<li><a href="/tags.html#ASP.Net-ref">ASP.Net <span>6</span></a></li>
     
    	<li><a href="/tags.html#jQuery-ref">jQuery <span>7</span></a></li>
     
    	<li><a href="/tags.html#MOSS-ref">MOSS <span>12</span></a></li>
    
  



    </ul>
    

    <hr>
    <div class="pagination">
      <ul>
      
        <li class="prev"><a href="/2009/03/24/jquery-performance-optimization-tips" title="jQuery performance optimization tips">&larr; Previous</a></li>
      
        <li><a href="/archive.html">Archive</a></li>
      
        <li class="next"><a href="/2009/03/31/building-an-ajax-web-part-with-jquery-part-2" title="Building an AJAX web part with jQuery (Part 2)">Next &rarr;</a></li>
      
      </ul>
    </div>
    <hr>
    


  <div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_developer = 1;
    var disqus_shortname = 'jekyllbootstrap'; // required: replace example with your forum shortname
    var disqus_identifier = '562 http://username.github.io/?p=562';
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>




  </div>
</div>


      </div>
      <hr>
      <footer>
        <p>&copy; 2013 Peter Gerritsen
          with help from <a href="http://jekyllbootstrap.com" target="_blank" title="The Definitive Jekyll Blogging Framework">Jekyll Bootstrap</a>
          and <a href="http://twitter.github.com/bootstrap/" target="_blank">Twitter Bootstrap</a>
        </p>
      </footer>

    </div>

    
  </body>
</html>

